# 【网络协议 6】IP协议、ARP协议、RARP协议✅

# **IP数据报**

IP是 TCP/IP 协议族中最核心的协议，所有的 TCP、UDP、ICMP、IGMP 数据都以 IP 数据报的格式传输。IP 仅提供尽力而为的传输服务，如果发生某种错误，IP 会丢失该数据，然后发送 ICMP 消息给信源端。另外，IP 数据报可以不按发送顺序接受。

IP数据报的格式如下：

![Untitled](%E3%80%90%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%206%E3%80%91IP%E5%8D%8F%E8%AE%AE%E3%80%81ARP%E5%8D%8F%E8%AE%AE%E3%80%81RARP%E5%8D%8F%E8%AE%AE%E2%9C%85%205180f5f0b0ba4706a47ace2e9cd7f4bb/Untitled.png)

前20字节和紧接其后的选项部分是IP数据报的首部，前20个字节是固定的，选项可有可无。首部的每一行是一个32位字的单位，最高位在左边，为0bit，最低位在右边，为31bit。4字节的32bit值按照以下次序传输：首先0-7bit，其次8-15比特，然后16-23bit，最后是24-31bit，这种传输次序称为big endian字节序（我们在C语言写位操作的算法时常用到该词）。TCP/IP首部中的所有二进制整数在网络中传输时都要求以这种次序，因此它又称作网络字节序，其他形式存储的二进制数据，如little endian格式，则必须在传输数据之前把首部转化成网络字节序。

首部长度是指首部占32bit字的数目，因为4位的最大值为15，因此首部最长为60字节，也即是说选项部分的最大值为40字节，不够4的倍数，要用0填充，使数据部分的起始地址为4的倍数。

总长度指整个IP数据报的长度，包括首部和数据部分，16bit，最长可达65535字节。尽管理论上可以传送一个长达65535的IP数据报，但实际上还要考虑网络的最大承载能力等因素，标准的TCP/IP分组大小为576字节，减去IP首部的20个字节，TCP首部的20个字节，路由协议头的24个字节，为512字节，因此主机接受的数据报的数据部分一般不超过512个字节。（PS：这点看的也不是太懂，网上很多人也有此疑问，谢希仁的计算机网络中写的一次IP数据报最少576字节，尼玛这里翻译的是不超过576字节，先往后看吧，说不定看到后面就豁然开朗了）。

这两天差不多算是搞明白了，很多基于UDP协议的应用之所以要求UDP的数据部分不超过512个字节（576-20-20），主要是考虑整个传输路径上的效率，因为链路层为X2.5的网络的MTU为576个字节，这基本也是各种链路层网络的最小MTU，大于这个值就不会产生分片，之所以建议不超过这个值应该是考虑到网络承载能力和传输效率、每台主机的接受能力等很多因素的权衡。当然书上也说，576只是建议值，实际上大于它也是可以的，只是这样在遇到X2.5网络时可能产生分片。暂时是这么理解的，不知道看到后面会不会有新的收获。

第十一章中又有说：现在许多但不是所有的广域网都可以处理大于512字节的分组。

3个标志位主要用来标识分片的IP数据报，片位移为分片的数据报的首个字节偏离整个原始数据报的位置。

# **IP路由选择**

主机通过路由器和目的主机连接。主机通过IP数据报连接目的主机时，按照如下步骤搜索（同一网络中的搜索要经过ARP协议将目的主机的IP地址解析为MAC地址）：

1. 搜索路由表，优先搜索匹配主机，如果能找到和IP地址完全一致的目标主机，则将该包发向目标主机
2. 搜索路由表，如果匹配主机失败，则匹配同子网的路由器，这需要子网掩码的协助。如果找到路由器，则将该包发向路由器。
3. 搜索路由表，如果匹配同子网路由器失败，则匹配同网号路由器，如果找到路由器，则将该包发向路由器。
4. 搜索路由表，如果以上都失败了，就搜索默认路由，如果默认路由存在，则发包
5. 如果都失败了，就丢掉这个包。

# **子网掩码**

主机号再分成一个子网号和主机号，便将一个网络又划分成了若干子网，子网掩码与该子网中的IP地址相与，便得到该子网，另外，子网对于子网内部的路由器是不透明的，也就是说IP数据报传到该网络的网关时，网关再将该数据报传送到子网的默认路由器上，最后通过该路由器再交付给该主机。

# **ARP协议和RARP协议**

前面已经说过，ARP协议只用在局域网中，它用来将IP地址解析为MAC地址。局域网中的每个主机都有一个ARP缓存，它保存了最近发起的IP地址到MAC地址的映射记录，当该主机要向局域网中的某一主机发送数据时，它会先从自己的缓存中查找，看是否存在目标IP地址，如果找到，就通过映射找到它的MAC地址，从而发送过去，如果没有找到该目的IP地址，它就向该局域网内发送一个广播，广播中包含自己的IP地址、MAC地址和目的主机的IP地址，局域网内的所有主机都会收到该广播，但只有目的IP地址的主机会做出回应，并把自己的MAC地址发送给源主机，源主机收到后，在自己的ARP缓存中增加上该映射，并根据发来的MAC地址将数据发送给目的主机。

ARP高速缓存中的表项一般都要设置超时值，如果一段时间内没有与某主机通信，就将该主机对应的IP与MAC之间的映射关系去掉，下次在需要通信时，依然发送广播。

如果ARP请求是从一个网络的主机到另一个网络的主机，那么连接这两个网络的路由器就可以回答该请求，这个过程成为ARP代理。

RARP协议则刚好相反，它将MAC地址解析成为对应的IP地址，通常在DHCP中有集成，现在已很少单独使用。