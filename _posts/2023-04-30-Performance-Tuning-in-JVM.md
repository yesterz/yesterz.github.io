---
title: 性能调优
date: 2023-04-30 21:09:00 +0800
author: 
categories: [JVM]
tags: [JVM]
pin: false
math: false
mermaid: true
img_path: /assets/images/
---

- [ ] 调优步骤 P192

## 衡量系统现状

随着系统数据量的不断增长，访问量的不断提升，系统的响应通常会越来越慢，又或是编写的新的应用在性能上无法满足需求，这个时候需要对系统的性能进行调优。调优过程是一个相当复杂的过程，涉及很多的方面：硬件、操作系统、运行环境软件以及应用本身，通常调优的步骤如图所示

调优前首先要做的是衡量系统现状，这包括目前系统的请求次数、响应时间、资源消耗等信息，例如 A 系统目前 95%的请求响应时间为1秒。

在有了系统现状后可设定调优目标，通常调优目标是根据用户所能接受的响应速度或系统所拥有的机器以及所支撑的用户量制定出来的，因此通常会设定出调优目标：95%的请求要在500ms内返回。在设定了调优的目标后，需要做的是寻找出性能瓶颈，这一步最重要的是找出造成目前系统性能不足的最大瓶颈点。找出后，可结合一些工具来找出造成瓶颈点的代码，到此才完成了这个步骤。

在寻找到了造成瓶颈点的代码后，通常需要分析其需求场景，然后结合一些优化的技巧制定优化的策略。优化策略或简或繁，选择其中收益比（优化后的预期效果/优化需要付出的代价）最高的优化方案，进行优化。

优化部署后，继续衡量系统的状况，如已达到目标，则可结束此次调优：如仍未达到目标，则要看是否产生了新的性能瓶颈。或可以考虑继续尝试上一步中制定的其他优化方案，直到达成调优目标或论证在目前的体系结构上无法达成调优目标为止。
Facebook为了将其网站的访问速度提升两倍，在上面的寻找性能瓶颈、性能优化、衡量是否达到调优的目标中循环了多次，最终在花费了6个月的时间后终于达到了调优的目标。

本章主要介绍如何寻找性能的瓶颈以及性能调优常用的一些方法。

**先粗粒度的划分，再细粒度地寻找具体的点**

## 寻找性能瓶颈

通常性能瓶颈的表象是资源消耗过多、外部处理系统的性能不足，或者资源消耗不多，但程序的响应速度却仍达不到要求。

资源主要消耗在CPU、文件IO、网络IO以及内存方面，机器的资源是有限的，当某资源消耗过多时，通常会造成系统的响应速度慢。

外部处理的性能不够主要是所调用的其他系统提供的功能或数据库操作的响应速度不够，所调用的其他系统性能不足，多数情况下也是资源消耗过多，但程序的性能不足造成的：数据库操作性能不足通常可以根据数据库的 sql 执行速度、数据库机器的IOPS、数据库的 Active Sessions 等分析出来。资源消耗不多，但程序的响应速度仍达不到要求的主要原因是程序代码运行效率不够高、未充分使用资源或程序结构不合理。

对于 Java 应用而言，寻找性能瓶颈的方法通常为首先分析资源的消耗，然后结合 Java 的一些工具来查找程序中造成资源消耗过多的代码，下面就以 Linux 和 Sun JDK 为例来介绍如何查找 Java 应用的性能瓶颈。

### CPU 消耗分析

在 Linux 中，CPU 主要用于中断、内核以及用户进程的任务处理，优先级为中断 > 内核 > 用户进程。

### 文件 IO 消耗分析


### 网络 IO 消耗分析



### 内存消耗分析


### 程序执行慢原因分析

有些情况是资源消耗不多，但程序执行仍然慢，这种情况多出现于访问量不是非常大的情况下，造成这种现象的原因主要有以下三种：
1. 锁竞争激烈
2. 未充分利用硬件资源
3. 数据量增长




## 性能调优

调优提提高系统性能，可以从硬件、操作系统，JVM 以及程序四个方面来着手。

### JVM 调优



### 程序调优

#### CPU 消耗严重


#### 文件 IO 消耗严重


#### 网络 IO 消耗严重


#### 对于内存消耗严重

1. 释放不必要的引用
2. 使用对象缓存池
3. 采用合理的缓存失效算法
4. 合理使用`SoftReference`和`WeakReference`

### 对于资源消耗不多，但程序执行慢的情况

对于分布式应用而言，造成这种情况的主要原因通常有锁竞争激烈以及未充分发挥硬件资源两种。

#### 锁竞争激烈


#### 未充分使用硬件资源

主要是 CPU 和内存




