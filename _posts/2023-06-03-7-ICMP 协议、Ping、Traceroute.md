---
title: ICMP 协议、Ping、Traceroute ✅
date: 2023-06-03 21:09:00 +0800
categories: [Computer Networking]
author: ltfy
tags: [Computer Networking]
pin: false
math: false
mermaid: false
---

# 【网络协议 7】ICMP 协议、Ping、Traceroute ✅

## **ICMP 协议**

ICMP 经常被认为是IP层的一个组成部分，它是网络层的一个协议，它传递差错报文以及其他需要注意的信息，ICMP 报文通常被 IP 层或更高层（TCP、UDP等）使用，它是在 IP 数据报内传输的。

ICMP 报文大致分为两类：查询报文和差错报文。

先来看差错报文。当传送 IP 数据报发生错误时（比如主机不可达、网络不可达等），ICMP 协议将会发送一个 ICMP 差错报文给源主机，好让主机做出相应的处理，也因此IP层以上的一些协议有可能做到可靠传输。书中给出了 ICMP 差错报文中的一些组合（类型和代码的组合）描述：如网络不可达、网络不可达、协议不可达、端口不可达等。**这里说下端口不可达的意思**：UDP 的规则之一是，如果收到一份 UDP 数据报而目的端口与某个正在使用的进程不相符，那么UDP返回一个ICMP不可达报文，将报文中的类型和代码的组合设定为端口不可达。Traceroute 程序就是利用端口不可达来产生 ICMP 差错报文的。

另外，在大多数情况下，传送IP数据报发生错误，会产生一个ICMP错误报文，但下面各种情况都不会导致产生ICMP差错报文：

- ICMP 差错报文不会产生差错报文（ICMP 查询报文可能会产生 ICMP 差错报文）；
- 目的地址是广播地址和多播地址的IP数据报；
- 作为链路层广播的数据报；
- 不是 IP 分片的第一片
- 源地址不是单个主机的数据报。

这些规则是为了防止过去允许 ICMP 差错报文对广播分组影响所带来的广播风暴。

再来看ICMP查询报文，查询报文主要用途有：

- 子网掩码查询；
- 时间戳查询；
- ping查询。

## **ping 程序**

ping 是 ICMP 的一个很著名的应用。ping 程序时对两个 TCP/IP 系统连通性进行测试的基本工具，它只利用 ICMP 回显请求和回显应答报文，而不用经过传输层，ping 服务器一般在内核中试下 ICMP 的功能。当某一个网站访问不了时，我们就可以 ping 一下这个网站，看下连通情况。比如下图：

![Untitled](%E3%80%90%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%207%E3%80%91ICMP%20%E5%8D%8F%E8%AE%AE%E3%80%81Ping%E3%80%81Traceroute%20%E2%9C%85%20e1183b9bb70d4106b236f667d76fd6f3/Untitled.png)

这里先 ping 到 google 的服务器，我们可以看到连通性不是很好，丢包率为50%，而我们又 ping 了下 Github 的服务器，连通性比较好，丢包率为0%。

## **Traceroute 程序**

Traceroute 是 ICMP 协议的另一个重要应用，主要用来侦测源主机到目的主机之间所经过的路由的情况。Traceroute 使用 ICMP 报文和 IP 首部中的 TTL 字段，其原理很简单，开始时发送一个 TTL 字段为 1 的 UDP 数据报，而后每次收到ICMP超时报文后，再发送一个 TTL 字段加 1 的 UDP 数据报，以确定路径中的每个路由器，而每个路由器在丢弃 UDP 数据报时都会返回一个 ICMP 超时报文，最终到达目的主机后，由于 ICMP 选择了一个不可能的值作为 UDP 端口（大于30000）。这样目的主机就会发送一个端口不可达的ICMP差错报文。